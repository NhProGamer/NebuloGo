<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NebuloGo</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/css/app.css">
</head>

<body>
<ul>
    <li><a href="#files">Files</a></li>
</ul>

<div class="files" id="files">
    <ul>
        <div id="filePlaceholder"></div>
    </ul>
</div>

<div id="progressContainer" class="progressContainer"></div>

<!-- Custom context menu -->
<div class="custom-menu" id="custom-menu">
    <button onclick="renameFile()" title="Rename file">Renommer</button>
    <button onclick="deleteFile()" title="Delete file">Supprimer</button>
    <button onclick="createFolder()" title="Create new folder">Create new folder</button>
    <button title="Share file">Partager</button>
</div>

<script defer>
    let ActualPath = "{{.ActualPath}}";
    let UserId = "{{.UserId}}";
    let SelectedItem = new Map();
    SelectedItem.set('Name', "");
    SelectedItem.set('Type', "");
    const MAX_PARALLEL_UPLOADS = 3;

    // Utility function to update the URL without reloading
    function changeFolder(folderId) {
        ActualPath += folderId + "/";
        history.pushState({ path: ActualPath }, null, '?path=' + ActualPath);
        loadFolderContent();
    }

    // Load folder content dynamically
    function loadFolderContent() {
        fetch(`/api/v1/files/content?userId=${UserId}&path=${ActualPath}`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('filePlaceholder').innerHTML = renderFolderContent(data);
            })
            .catch(error => console.error('Error loading content:', error));
    }

    // Generate folder and file HTML
    function renderFolderContent(data) {
        if (!data || data.length === 0) {
            return 'Dossier vide';  // Ne rien faire si data est vide
        }
        return data.map(item => {
            if (item.Type === 'file') {
                return `
                    <div class="item" data-info="${item.Name}" data-type="file">
                        <i class='bx bx-file'></i>
                        <a href="/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${item.Name}" title="${item.Name}">${item.Name}</a>
                    </div>`;
            } else if (item.Type === 'directory') {
                return `
                    <div class="item" data-info="${item.Name}" data-type="directory" onclick="changeFolder('${item.Name}')">
                        <i class='bx bx-folder'></i> ${item.Name}
                    </div>`;
            }
        }).join('');
    }

    // Handle browser navigation using the back button
    window.addEventListener('popstate', event => {
        ActualPath = (event.state && event.state.path !== null) ? event.state.path : "";
        loadFolderContent();
    });

    // ---------------------- UPLOAD FILES ----------------------

    const dropZone = document.getElementById('files');
    const progressContainer = document.getElementById('progressContainer');

    // Prevent default behavior for drag-and-drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => e.preventDefault());
    });

    // Handle file drop
    dropZone.addEventListener('drop', event => {
        const files = event.dataTransfer.files;
        if (files.length) {
            handleFiles(files);
        }
    });

    // Upload files with parallel limit
    function handleFiles(files) {
        progressContainer.innerHTML = ''; // Clear existing progress bars
        const queue = Array.from(files);
        let activeUploads = 0;

        function startUpload() {
            while (activeUploads < MAX_PARALLEL_UPLOADS && queue.length > 0) {
                const file = queue.shift();
                uploadFile(file);
            }
        }

        function uploadFile(file) {
            activeUploads++;

            // Create progress bar elements
            const progressWrapper = document.createElement('div');
            const progressBarContainer = document.createElement('div');
            const progressBar = document.createElement('div');
            const progressText = document.createElement('p');

            progressWrapper.style.marginBottom = '10px';
            progressBarContainer.style.width = '100%';
            progressBarContainer.style.backgroundColor = '#f3f3f3';
            progressBar.style.width = '0%';
            progressBar.style.height = '20px';
            progressBar.style.backgroundColor = '#4caf50';

            progressBarContainer.appendChild(progressBar);
            progressWrapper.appendChild(progressBarContainer);
            progressWrapper.appendChild(progressText);
            progressContainer.appendChild(progressWrapper);

            const formData = new FormData();
            formData.append('file', file);

            axios.post(`/api/v1/files?UserId=${UserId}&path=${ActualPath}&filename=${file.name}`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' },
                withCredentials: true,
                onUploadProgress: progressEvent => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    progressBar.style.width = percentCompleted + '%';
                    progressText.textContent = percentCompleted + '%';
                }
            })
                .then(response => {
                    console.log('Upload succeeded:', response.data);
                    loadFolderContent();
                })
                .catch(error => {
                    console.error('Upload failed:', error);
                })
                .finally(() => {
                    activeUploads--;
                    startUpload();
                });
        }

        startUpload(); // Start the first set of uploads
    }

    // ---------------------- CONTEXT MENU ----------------------

    document.addEventListener('contextmenu', e => {
        const menu = document.getElementById('custom-menu');
        const clickedElement = e.target.closest('.item');
        if (clickedElement) {
            e.preventDefault();
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.style.display = 'block';

            const name = clickedElement.getAttribute('data-info');
            const type = clickedElement.getAttribute('data-type');
            SelectedItem.set('Name', name);
            SelectedItem.set('Type', type);
        }
    });

    document.addEventListener('click', () => {
        document.getElementById('custom-menu').style.display = 'none';
        SelectedItem.set('Name', "");
        SelectedItem.set('Type', "");
    });

    // ---------------------- FILE OPERATIONS ----------------------

    function deleteFile() {
        if (SelectedItem.get("Type") === "file") {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        } else {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        }
    }

    function renameFile() {
        let newName = prompt("Enter new name:", SelectedItem.get('Name'));
        if (newName) {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}&newName=${newName}`, {
                method: 'PATCH',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error renaming file:', error));
        }
    }

    function createFolder() {
        let folderName = prompt("Enter name:");
        if (folderName) {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${folderName}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error creating folder:', error));
        }
    }

    // Load folder content initially
    loadFolderContent();
</script>
</body>
</html>
