<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NebuloGo - Gestionnaire de fichiers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body class="bg-gray-100 h-screen flex flex-col">
<!-- Barre de navigation (fixe) -->
<nav class="bg-blue-500 text-white p-4 shadow-md fixed top-0 left-0 right-0 z-10">
    <div class="container mx-auto flex justify-between">
        <h1 class="text-xl font-semibold">NebuloGo Files</h1>
        <div class="flex space-x-4">
            <a href="#" class="hover:text-gray-200">Home</a>
            <a href="#" class="hover:text-gray-200">Settings</a>
            <a href="/logout" class="hover:text-gray-200">Logout</a>
        </div>
    </div>
</nav>

<!-- Liste des fichiers (scrollable) -->
<main class="flex-grow overflow-y-auto mt-16">
    <div class="container mx-auto py-6 h-full" id="file-container">
        <ul class="space-y-4" id="filePlaceholder">
        </ul>
    </div>
</main>

<!-- Menu contextuel personnalisé -->
<div id="contextMenu" class="custom-context-menu">
    <button id="download" onclick="downloadFile()">Télécharger</button>
    <button id="rename" onclick="renameFile()">Renommer</button>
    <button id="delete" onclick="deleteFile()">Supprimer</button>
    <button id="newFolder" onclick="createFolder()">Nouveau dossier</button>
    <button id="share">Partager</button>
</div>

<!-- Panneau rétractable pour les uploads -->
<div id="uploadMenu">
    <h3>Upload en cours</h3>
    <div class="upload-list" id="uploadList"></div>
</div>

<script defer>
    let ActualPath = "{{.ActualPath}}";
    let UserId = "{{.UserId}}";
    let SelectedItem = new Map();
    SelectedItem.set('Name', "");
    SelectedItem.set('Type', "");
    const MAX_PARALLEL_UPLOADS = 3;

    // Utility function to update the URL without reloading
    function changeFolder(folderId) {
        ActualPath += folderId + "/";
        history.pushState({ path: ActualPath }, null, '?path=' + ActualPath);
        loadFolderContent();
    }

    // Load folder content dynamically
    function loadFolderContent() {
        fetch(`/api/v1/files/content?userId=${UserId}&path=${ActualPath}`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                document.getElementById('filePlaceholder').innerHTML = renderFolderContent(data);
            })
            .catch(error => console.error('Error loading content:', error));
    }

    // Generate folder and file HTML
    function renderFolderContent(data) {
        if (!data || data.length === 0) {
            return 'Dossier vide';  // Ne rien faire si data est vide
        }
        return data.map(item => {
            const parsedDate = new Date(item.Time);

            // Extraire les composants de la date
            const day = String(parsedDate.getDate()).padStart(2, '0'); // Jour
            const month = String(parsedDate.getMonth() + 1).padStart(2, '0'); // Mois (0-11, donc +1)
            const year = String(parsedDate.getFullYear()).slice(-2); // Année (deux derniers chiffres)
            const hours = String(parsedDate.getHours()).padStart(2, '0'); // Heures
            const minutes = String(parsedDate.getMinutes()).padStart(2, '0'); // Minutes

            // Construire la chaîne formatée
            const formattedDate = `${day}/${month}/${year} ${hours}h${minutes}`;

            if (item.Type === 'file') {
                //<a href="/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${item.Name}"
                return `
                <li class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between context-menu-target" data-info="${item.Name}" data-type="file">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="24px" height="24px"><path fill="#c9dcf4" d="m71.99,88.11c-14.66,1.19-29.31,1.19-43.97,0-3.67-.3-6.52-3.29-6.71-6.96-1.04-20.43-1.04-40.86,0-61.3.19-3.68,3.05-6.66,6.72-6.96,9.87-.8,19.74-1.06,29.62-.78,2.13.06,4.14.98,5.62,2.52,4.46,4.66,9.01,9.34,13.6,13.94,1.47,1.47,2.33,3.45,2.39,5.53.43,15.69.24,31.37-.55,47.06-.19,3.67-3.04,6.66-6.71,6.96Z"/><path fill="#4a254b" d="m50,73c2.57,0,4.68-1.94,4.97-4.43.03-.3-.19-.57-.49-.57-1.73,0-7.22,0-8.95,0-.3,0-.53.27-.49.57.28,2.49,2.4,4.43,4.97,4.43Z"/><circle cx="39.5" cy="61.5" r="5.5" fill="#fff"/><circle cx="39.5" cy="61.5" r="2.5" fill="#4a254b"/><circle cx="60.5" cy="61.5" r="5.5" fill="#fff"/><circle cx="60.5" cy="61.5" r="2.5" fill="#4a254b"/><path fill="#6b96d6" d="m68.63,31.42h10.08c-.41-1.06-1.03-2.04-1.85-2.87-4.58-4.6-9.13-9.28-13.6-13.94-.9-.94-2-1.64-3.21-2.07l.02,10.32c.01,4.72,3.84,8.54,8.56,8.54Z"/></svg>
                    <p class="text-sm font-semibold">${item.Name}</p>
                </div>
                <span class="text-sm text-gray-500">Modifié le ${formattedDate}</span>
            </li>`;
            } else if (item.Type === 'directory') {
                return `
                <li class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between context-menu-target" data-info="${item.Name}" data-type="directory" onclick="changeFolder('${item.Name}')">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="24px" height="24px"><path fill="#ff931e" d="m19.2,29.71c-6.62-1.93-6.83,3.92-7.06,9.31-.4,9.57,2.28,18.79,2.35,28.31.02,3.14-.97,7.87.54,10.77,1.23,2.36,3.68,2.04,6,2.04,10.13,0,20.25,0,30.38,0s19.22.83,28.87.86c1.9,0,5.28.08,6.69-1.55s1.14-5.74,1.28-7.76c.64-9.01.19-17.85-1.05-26.79-.84-6.04-.05-12.58-7.29-13.93-9.64-1.79-19.97.28-29.71-.54-9.57-.8-19.38-2.56-28.98-1.24-1.9.26-1.09,3.15.8,2.89,8.76-1.21,18.09.27,26.81,1.18s18.06.26,26.92.41c1.56.03,3.5-.14,4.94.54,3.31,1.56,2.54,3.95,2.91,6.79.68,5.18,1.76,10.37,1.89,15.6.09,3.65.22,7.38,0,11.02s1.06,9.98-3.81,10.38c-8.45.7-17.06-.92-25.52-.86-9.79.07-19.59-.03-29.38-.02-1.77,0-6.15.82-7.68.02-2.13-1.11-1.65-2.99-1.64-4.87.01-4.28.14-8.57-.39-12.83-.63-5.07-1.72-10.03-1.92-15.15-.11-2.68-1.19-12.98,3.24-11.69,1.86.54,2.65-2.35.8-2.89h0Z"/><path fill="#fec933" d="m88.27,31.39c-.42-3.57-3.83-6.61-7.38-6.77-14.07-.57-28.14-.74-42.2-.53l-1.16-2.9c-.72-1.79-2.45-2.96-4.38-2.96h-16.32c-2.47,0-4.52,1.91-4.7,4.38l-.82,11.44h.15c-.76,8.27-.67,16.55.26,24.83.42,3.57,3.83,6.61,7.38,6.77,20.59.83,41.19.83,61.78,0,3.56-.15,6.97-3.2,7.38-6.77,1.04-9.16,1.04-18.32,0-27.49Z"/><path fill="#fec933" d="m82.98,81.05c-21.99.96-43.98.96-65.97,0-2.49-.11-4.56-1.94-5.01-4.39-2.42-13.23-3.46-26.39-2.8-39.47.14-2.73,2.33-4.91,5.06-5.04,23.82-1.13,47.65-1.13,71.47,0,2.73.13,4.92,2.32,5.06,5.04.66,13.08-.38,26.24-2.8,39.47-.45,2.45-2.52,4.29-5.01,4.39Z"/><path fill="#4a254b" d="m50,70c2.57,0,4.68-1.94,4.97-4.43.03-.3-.18-.57-.49-.57-1.72,0-7.23,0-8.96,0-.3,0-.52.27-.49.57.28,2.49,2.4,4.43,4.97,4.43Z"/><circle cx="37" cy="58" r="6" fill="#fff"/><circle cx="37" cy="58" r="2.75" fill="#4a254b"/><path fill="#4a254b" d="m88.82,33.19c-.11,0-.22-.04-.31-.11-.8-.65-1.77-1.02-2.8-1.07-23.7-1.12-47.73-1.12-71.42,0-.83.04-1.63.29-2.33.73-.23.15-.54.08-.69-.16-.15-.23-.08-.54.16-.69.84-.53,1.82-.84,2.81-.88,23.73-1.12,47.79-1.12,71.52,0,1.24.06,2.41.5,3.38,1.29.21.17.25.49.07.7-.1.12-.24.19-.39.19Z"/><circle cx="63" cy="58" r="6" fill="#fff"/><circle cx="63" cy="58" r="2.75" fill="#4a254b"/></svg>
                    <p class="text-sm font-semibold">${item.Name}</p>
                </div>
                <span class="text-sm text-gray-500">Modifié le ${formattedDate}</span>
            </li>`;
            }
        }).join('');
    }

    // Handle browser navigation using the back button
    window.addEventListener('popstate', event => {
        ActualPath = (event.state && event.state.path !== null) ? event.state.path : "";
        loadFolderContent();
    });

    // ---------------------- UPLOAD FILES ----------------------

    const dropZone = document.getElementById('file-container');

    // Prevent default behavior for drag-and-drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => e.preventDefault());
    });

    function openUploadMenu() {
        document.getElementById('uploadMenu').classList.add('show');
    }

    // Fonction pour fermer le panneau des uploads
    function closeUploadMenu() {
        document.getElementById('uploadMenu').classList.remove('show');
    }

    function addUploadToMenu(filename) {
        let uploadItem = document.createElement('div');
        uploadItem.classList.add('upload-item');
        uploadItem.innerHTML = `
                <p>${filename}</p>
                <div class="progress-bar" style="width: 0%;"></div>
            `;
        document.getElementById('uploadList').appendChild(uploadItem);

    }

    function updateUploadMenu() {
        document.getElementById('uploadList')
    }

    // Handle file drop
    dropZone.addEventListener('drop', event => {
        const files = event.dataTransfer.files;
        if (files.length) {
            Array.from(files).forEach(file => {
                //addUploadToMenu(file.name)
                uploadFile(file)
            })
            //openUploadMenu()
        }
    });

    // ---------------------- CONTEXT MENU ----------------------

    // Variables pour gérer le menu contextuel
    const contextMenu = document.getElementById('contextMenu');
    let targetElement = null;

    // Fonction pour afficher le menu contextuel
    document.addEventListener('contextmenu', function (e) {
        // Si le clic droit est effectué sur un fichier
        const clickedElement = e.target.closest('.context-menu-target');
        if (clickedElement) {
            e.preventDefault();
            targetElement = e.target.closest('.context-menu-target');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            const name = clickedElement.getAttribute('data-info');
            const type = clickedElement.getAttribute('data-type');
            SelectedItem.set('Name', name);
            SelectedItem.set('Type', type);
            if (type !== "file") {
                document.getElementById('download').style.display = 'none'
            } else  {
                document.getElementById('download').style.display = 'block'
            }
        } else {
            contextMenu.style.display = 'none'; // Cacher si clic droit en dehors
        }
    });

    // Fonction pour cacher le menu contextuel quand on clique ailleurs
    document.addEventListener('click', function () {
        contextMenu.style.display = 'none';
    });

    // ---------------------- FILE OPERATIONS ----------------------

    function downloadFile() {
        window.location.href=`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}`;
    }

    function deleteFile() {
        if (SelectedItem.get("Type") === "file") {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        } else {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        }
    }

    function renameFile() {
        let newName = prompt("Enter new name:", SelectedItem.get('Name'));
        if (newName) {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}&newName=${newName}`, {
                method: 'PATCH',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error renaming file:', error));
        }
    }

    function createFolder() {
        let folderName = prompt("Enter name:");
        if (folderName) {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${folderName}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error creating folder:', error));
        }
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(event) {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                console.log(`Upload Progress: ${percentComplete}%`);
            }
        });
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                loadFolderContent()
                console.log('Upload réussi!');
            } else {
                console.log('Erreur lors de l\'upload')
            }
        });
        xhr.addEventListener('error', function() {
            console.log('Erreur réseau pendant l\'upload:', xhr.response)
        });
        xhr.withCredentials = true;
        xhr.open('POST', `/api/v1/files?UserId=${UserId}&path=${ActualPath}&filename=${file.name}`);
        xhr.send(formData);

    }

    // Load folder content initially
    loadFolderContent();
</script>
</body>
</html>
