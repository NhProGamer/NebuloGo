<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de fichiers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Style pour le menu contextuel */
        .custom-context-menu {
            display: none;
            position: absolute;
            background-color: white;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 1000;
            padding: 10px;
        }

        .custom-context-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            font-size: 14px;
            color: black;
        }

        .custom-context-menu button:hover {
            background-color: #f3f4f6;
        }

        /* Style pour le panneau rétractable d'uploads */
        #uploadMenu {
            position: fixed;
            right: 0;
            top: 50px;
            width: 300px;
            background-color: white;
            border-left: 1px solid #ccc;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        #uploadMenu.show {
            transform: translateX(0);
        }

        #uploadMenu h3 {
            background-color: #f3f4f6;
            padding: 12px;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
        }

        #uploadMenu .upload-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        #uploadMenu .upload-item {
            background-color: #f9f9f9;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        #uploadMenu .upload-item p {
            margin: 0;
        }

        #uploadMenu .progress-bar {
            height: 5px;
            background-color: #4caf50;
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
<!-- Barre de navigation (fixe) -->
<nav class="bg-blue-500 text-white p-4 shadow-md fixed top-0 left-0 right-0 z-10">
    <div class="container mx-auto flex justify-between">
        <h1 class="text-xl font-semibold">NebuloGo Files</h1>
        <div class="flex space-x-4">
            <a href="#" class="hover:text-gray-200">Home</a>
            <a href="#" class="hover:text-gray-200">Settings</a>
            <a href="#" class="hover:text-gray-200">Logout</a>
        </div>
    </div>
</nav>

<!-- Liste des fichiers (scrollable) -->
<main class="flex-grow overflow-y-auto mt-16">
    <div class="container mx-auto py-6" id="file-container">
        <ul class="space-y-4" id="filePlaceholder">
        </ul>
    </div>
</main>

<!-- Menu contextuel personnalisé -->
<div id="contextMenu" class="custom-context-menu">
    <button id="rename" onclick="renameFile()">Renommer</button>
    <button id="delete" onclick="deleteFile()">Supprimer</button>
    <button id="share">Partager</button>
    <button id="newFolder" onclick="createFolder()">Nouveau dossier</button>
</div>

<!-- Panneau rétractable pour les uploads -->
<div id="uploadMenu">
    <h3>Upload en cours</h3>
    <div class="upload-list" id="uploadList"></div>
</div>

<script defer>
    let ActualPath = "{{.ActualPath}}";
    let UserId = "{{.UserId}}";
    let SelectedItem = new Map();
    SelectedItem.set('Name', "");
    SelectedItem.set('Type', "");
    const MAX_PARALLEL_UPLOADS = 3;

    // Utility function to update the URL without reloading
    function changeFolder(folderId) {
        ActualPath += folderId + "/";
        history.pushState({ path: ActualPath }, null, '?path=' + ActualPath);
        loadFolderContent();
    }

    // Load folder content dynamically
    function loadFolderContent() {
        fetch(`/api/v1/files/content?userId=${UserId}&path=${ActualPath}`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                document.getElementById('filePlaceholder').innerHTML = renderFolderContent(data);
            })
            .catch(error => console.error('Error loading content:', error));
    }

    // Generate folder and file HTML
    function renderFolderContent(data) {
        if (!data || data.length === 0) {
            return 'Dossier vide';  // Ne rien faire si data est vide
        }
        return data.map(item => {
            if (item.Type === 'file') {
                //<a href="/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${item.Name}"
                return `
                <li class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between context-menu-target" data-info="${item.Name}" data-type="file">
                <div class="flex items-center">
                    <svg class="w-8 h-8 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round"
                                                                  stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7H3z"/><path stroke-linecap="round"
                                                                                                                                      stroke-linejoin="round" stroke-width="2" d="M5 9h14a2 2 0 002-2H3a2 2 0 002 2z"/></svg>
                    <p class="text-sm font-semibold">${item.Name}</p>
                </div>
                <span class="text-sm text-gray-500">Modifié le XX/XX/XXXX</span>
            </li>`;
            } else if (item.Type === 'directory') {
                return `
                <li class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between context-menu-target" data-info="${item.Name}" data-type="directory" onclick="changeFolder('${item.Name}')">
                <div class="flex items-center">
                    <svg class="w-8 h-8 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round"
                                                                  stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7H3z"/><path stroke-linecap="round"
                                                                                                                                      stroke-linejoin="round" stroke-width="2" d="M5 9h14a2 2 0 002-2H3a2 2 0 002 2z"/></svg>
                    <p class="text-sm font-semibold">${item.Name}</p>
                </div>
                <span class="text-sm text-gray-500">Modifié le XX/XX/XXXX</span>
            </li>`;
            }
        }).join('');
    }

    // Handle browser navigation using the back button
    window.addEventListener('popstate', event => {
        ActualPath = (event.state && event.state.path !== null) ? event.state.path : "";
        loadFolderContent();
    });

    // ---------------------- UPLOAD FILES ----------------------

    const dropZone = document.getElementById('file-container');
    const progressContainer = document.getElementById('uploadList');

    // Prevent default behavior for drag-and-drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => e.preventDefault());
    });

    // Handle file drop
    dropZone.addEventListener('drop', event => {
        const files = event.dataTransfer.files;
        if (files.length) {
            handleFiles(files);
        }
    });

    // ---------------------- CONTEXT MENU ----------------------

    // Variables pour gérer le menu contextuel
    const contextMenu = document.getElementById('contextMenu');
    let targetElement = null;

    // Fonction pour afficher le menu contextuel
    document.addEventListener('contextmenu', function (e) {
        // Si le clic droit est effectué sur un fichier
        const clickedElement = e.target.closest('.context-menu-target');
        if (clickedElement) {
            e.preventDefault();
            targetElement = e.target.closest('.context-menu-target');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            const name = clickedElement.getAttribute('data-info');
            const type = clickedElement.getAttribute('data-type');
            SelectedItem.set('Name', name);
            SelectedItem.set('Type', type);
        } else {
            contextMenu.style.display = 'none'; // Cacher si clic droit en dehors
        }
    });

    // Fonction pour cacher le menu contextuel quand on clique ailleurs
    document.addEventListener('click', function () {
        contextMenu.style.display = 'none';
    });

    // ---------------------- FILE OPERATIONS ----------------------

    function deleteFile() {
        if (SelectedItem.get("Type") === "file") {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        } else {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${SelectedItem.get('Name')}`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error deleting file:', error));
        }
    }

    function renameFile() {
        let newName = prompt("Enter new name:", SelectedItem.get('Name'));
        if (newName) {
            fetch(`/api/v1/files?userId=${UserId}&path=${ActualPath}&filename=${SelectedItem.get('Name')}&newName=${newName}`, {
                method: 'PATCH',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error renaming file:', error));
        }
    }

    function createFolder() {
        let folderName = prompt("Enter name:");
        if (folderName) {
            fetch(`/api/v1/files/folder?userId=${UserId}&path=${ActualPath}&folderName=${folderName}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => loadFolderContent())
                .catch(error => console.error('Error creating folder:', error));
        }
    }

    // Load folder content initially
    loadFolderContent();
</script>
</body>
</html>
